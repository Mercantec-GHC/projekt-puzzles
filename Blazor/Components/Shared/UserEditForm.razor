@rendermode InteractiveServer
@inject UserService userService
@inject AppState state

@if (loggedIn)
{
    <section>
        <div>
            <h2>Edit account</h2>

            <h3>@message</h3>

                <EditForm Model="@user" OnValidSubmit="@EditPassword" FormName="EditUserForm">
                <label>
                    Original Password
                        <InputText @bind-Value="originalPassword" type="password" required />
                </label>
                <label>
                    New Password
                    <InputText @bind-Value="user.Password" type="password" required />
                </label>
                <label>
                    Confirm password
                    <InputText @bind-Value="passwordCopy" type="password" required />
                </label>
                <button type="submit">Change password</button>
            </EditForm>

                <EditForm Model="@user" OnValidSubmit="@EditEmail" FormName="EditUserForm">
                <label>
                    Email
                    <InputText @bind-Value="user.Email" type="email" required />
                </label>
                <button type="submit">Change Email</button>
            </EditForm>

                <EditForm Model="@user" OnValidSubmit="@EditPhoneNumber" FormName="EditUserForm">
                <label>
                    Phone number
                    <InputText @bind-Value="user.PhoneNumber" type="tel" />
                </label>
                <button type="submit">Change phone number</button>
            </EditForm>
        </div>
    </section>
}



@code {
    [Parameter]
    public string username { get; set; }

    User user = new();
    string passwordCopy = "";
    string originalPassword = "";


    string message = "";
    bool loggedIn = false;


    /// <summary>
    /// Creates a new User object template with the current user's ID and username.
    /// Used as a base for updating user information without altering other fields.
    /// </summary>
    /// <returns>A new User object with UserId and Username set.</returns>
    private User ChangedUserTemplate()
    {
        User newUser = new();
        newUser.UserId = user.UserId;
        newUser.Username = user.Username;
        // Only copies ID and username; other fields are set in the specific edit methods.
        return newUser;
    }


    /// <summary>
    /// Handles the password change process for the user.
    /// Checks if the new password and confirmation match, then updates the password via the user service.
    /// </summary>
    private async Task EditPassword()
    {
        User newUser = ChangedUserTemplate();

        // Ensure the new password and confirmation match
        if (user.Password == passwordCopy)
        {
            newUser.Password = user.Password;

            // Update the user with the new password, passing the original password for verification
            await userService.UpdateUserAsync(newUser, originalPassword);

            originalPassword = "";
            message = "Your password has been updated";
        }
        else
        {
            message = "The passwords does not match";
        }
    }


    /// <summary>
    /// Handles the email change process for the user.
    /// Updates the user's email via the user service.
    /// </summary>
    private async Task EditEmail()
    {
        User newUser = ChangedUserTemplate();
        newUser.Email = user.Email;

        // Update the user with the new email
        await userService.UpdateUserAsync(newUser);

        message = "Your Email has been changed";
    }


    /// <summary>
    /// Handles the phone number change process for the user.
    /// Updates the user's phone number via the user service.
    /// </summary>
    private async Task EditPhoneNumber()
    {
        User newUser = ChangedUserTemplate();
        newUser.PhoneNumber = user.PhoneNumber;

        // Update the user with the new phone number
        await userService.UpdateUserAsync(newUser);

        message = "Your phone number has been changed";
    }


    /// <summary>
    /// Called by the Blazor framework when the component is initialized.
    /// Sets the user and login state if the current user matches the username parameter.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (state.CurrentUser != null)
        {
            if (state.CurrentUser.Username == username)
            {
                user = state.CurrentUser;
                loggedIn = true;
            }
        }
    }
}
