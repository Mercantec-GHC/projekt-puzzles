@rendermode InteractiveServer
@inject AdvertService ad
@using Blazor.Models

<div>
    <EditForm Model="@search" OnValidSubmit="@Search" FormName="SearchField">
        <div class="search-row">
            <label>
                Search
                <InputText type="search" @bind-Value="@search.SearchText" list="search-list" @oninput="UpdateSuggetions"></InputText>
            </label>

            <datalist id="search-list">
                @if (adverts != null)
                {
                    // Add the current search text as the first suggestion
                    <option value="@search.SearchText"></option>
                    // Add each advert's title as a suggestion, with the description as a label
                    @foreach (Advert advert in adverts)
                    {
                        <option value="@advert.Title" label="@advert.Description"></option>
                    }
                }
            </datalist>

            <button type="submit">Search</button>
        </div>

        <div class="search-row">

            
            <label>
                Filter range
                <select @bind="@search.FilterRange">
                    <option value="Price">Price</option>
                    <option value="Pieces">Pieces</option>
                </select>
            </label>
            <label>
                From
                <InputNumber @bind-Value="search.RangeMin" min="0"></InputNumber>
            </label>
            <label>
                To
                <InputNumber @bind-Value="search.RangeMax" min="0"></InputNumber>
            </label>
            
            <label>
                Order by
                <select @bind="@search.OrderBy">
                    <option value="Price">Price</option>
                    <option value="CreatedAt">Date</option>
                    <option value="PieceAmount">Pieces</option>
                </select>
            </label>
            <label>
                In order
                <select @bind="@search.InOrder">
                    <option value="ASC">Ascending</option>
                    <option value="DESC">Descending</option>
                </select>
            </label>
            
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public EventCallback<SearchParam> OnSearch { get; set; }

    SearchParam search = new();
    List<Advert> adverts;





    /// <summary>
    /// Executes a search for adverts based on the current search parameters.
    /// Updates the suggestions list and invokes the OnSearch callback.
    /// </summary>
    private async Task Search()
    {
        // Fetch up to 5 adverts matching the search text for suggestions
        adverts = await ad.GetAllAdvertsAsync(limit:5, searchTerm:search.SearchText);

        // If the maximum range is 0, treat it as no upper limit
        if (search.RangeMax == 0) search.RangeMax = null;

        // Notify parent component or handler of the search event
        await OnSearch.InvokeAsync(search);
    }


    /// <summary>
    /// Updates the advert suggestions as the user types in the search field.
    /// If the search text is empty, performs a full search; otherwise, fetches up to 4 suggestions.
    /// </summary>
    /// <param name="e">The change event containing the new input value.</param>
    private async Task UpdateSuggetions(ChangeEventArgs e)
    {
        search.SearchText = e.Value?.ToString();
        if (string.IsNullOrEmpty(search.SearchText)) {
            // If the search box is cleared, perform a full search
            await Search();
            return;
        }
        // Fetch up to 4 adverts for autocomplete suggestions
        adverts = await ad.GetAllAdvertsAsync(limit: 4, searchTerm: search.SearchText);
    }


    
}
