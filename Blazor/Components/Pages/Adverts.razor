@page "/adverts/{pageIndex:int}"
@rendermode InteractiveServer
@using Blazor.Components.Shared
@using Blazor.Models
@inject AdvertService ad


<PageTitle>Adverts</PageTitle>

<section>
    <div>
        <h1>Adverts</h1>
    </div>
</section>

<section>
    
    <SearchField OnSearch="OnSearch" />

    <div>
        <AdvertContainer Adverts="adverts" />
    </div>
</section>

<section>
    <PaginationBar pageIndex="pageIndex"
        NextPageUrl="@($"/adverts/{pageIndex + 1}")"
        PreviousPageUrl="@($"/adverts/{pageIndex - 1}")"
        isNextPageAvailable="isNextPage" />
</section>

@code {
    [Parameter]
    public int pageIndex { get; set; }

    const int adsPerPage = 40;
    int pageOffset;
    int advertCount;

    bool isNextPage = true;


    //string debug;

    SearchParam search = new();

    List<Advert> adverts;



    /// <summary>
    /// Handles the search event from the SearchField component.
    /// Updates the search parameters, gets the advert count, and loads the adverts for the current filter.
    /// </summary>
    private async Task OnSearch(SearchParam searchParam)
    {
        search = searchParam;

        // Get the total number of adverts matching the current filter
        if (search.FilterRange == filterRangeType.Price)
        {
            advertCount = await ad.GetAdvertCountAsync(searchTerm: search.SearchText, minPrice: search.RangeMin, maxPrice: search.RangeMax);
        }
        else
        {
            advertCount = await ad.GetAdvertCountAsync(searchTerm: search.SearchText, minPieceAmount: search.RangeMin, maxPieceAmount: search.RangeMax);
        }

        await LoadAdverts();

        //debug = searchParam;
    }


    /// <summary>
    /// Called by the Blazor framework when component parameters change (e.g., pageIndex).
    /// Loads the adverts for the current page and filter.
    /// </summary>
    protected override async Task OnParametersSetAsync()
    {
        await LoadAdverts();
    }


    /// <summary>
    /// Loads the adverts for the current page and filter.
    /// Calculates the page offset, fetches adverts, and determines if a next page is available.
    /// </summary>
    private async Task LoadAdverts()
    {
        pageOffset = adsPerPage * (pageIndex - 1);

        // Fetch adverts based on the selected filter range (price or pieces)
        if (search.FilterRange == filterRangeType.Price)
        {
            adverts = await ad.GetAllAdvertsAsync(limit: adsPerPage, offset: pageOffset, searchTerm: search.SearchText, minPrice: search.RangeMin, maxPrice: search.RangeMax, orderBy: Enum.GetName(search.OrderBy), orderDirection: Enum.GetName(search.InOrder));
        }
        else
        {
            adverts = await ad.GetAllAdvertsAsync(limit: adsPerPage, offset: pageOffset, searchTerm: search.SearchText, minPieceAmount: search.RangeMin, maxPieceAmount: search.RangeMax, orderBy: Enum.GetName(search.OrderBy), orderDirection: Enum.GetName(search.InOrder));
        }

        // Determine if there is a next page
        if ((pageOffset + adsPerPage) >= advertCount)
        {
            isNextPage = false;
        }
        else
        {
            isNextPage = true;
        }
    }


    /// <summary>
    /// Called by the Blazor framework when the component is initialized.
    /// Loads the total advert count for all adverts.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        advertCount = await ad.GetAdvertCountAsync();
    }
}