@page "/add-advert"
@rendermode InteractiveServer
@using Blazor.Components.Shared
@inject AdvertService ad
@inject AppState state
@inject NavigationManager nav

<PageTitle>Add advertisement</PageTitle>



<section>
    <div>
        <h1>Add advertisement</h1>
    </div>
</section>

<section>
    <div>
        <EditForm Model="@advert" OnValidSubmit="@NewAdvert" FormName="AdvertForm">
            <FileInput OnChange="@OnFileChange" OnClear="@ClearFile" Label="Image" />

            @if (advert.Picture != null)
            {
                <div>
                    <AdvertImage Picture="advert.Picture"></AdvertImage>
                </div>
            }

            <label>
                Puzzle Title
                <InputText @bind-Value="advert.Title" required />
            </label>
            <label>
                Describtion
                <InputTextArea @bind-Value="advert.Description" required/>
            </label>
            <label>
                Piece amount
                <InputNumber @bind-Value="advert.PieceAmount" step="1" required />
            </label>
            <label>
                Price
                <InputNumber @bind-Value="advert.Price" step="1" required />
            </label>
            <div class="form-group">
                <h3>Box dimensions</h3>

                <div class="form-group-contents">
                    <label>
                        Width:
                        <InputNumber @bind-Value="advert.BoxDimensions.Width" step="0.1" />
                    </label
                    <label>
                        Height
                        <InputNumber @bind-Value="advert.BoxDimensions.Height" step="0.1" />
                    </label>
                    <label>
                        Depth:
                        <InputNumber @bind-Value="advert.BoxDimensions.Depth" step="0.1" />
                    </label>
                </div>
            </div>

            <div class="form-group">
                <h3>Puzzle dimensions</h3>

                <div class="form-group-contents">
                    <label>
                        Width:
                        <InputNumber @bind-Value="advert.PuzzleDimensions.Width" step="0.1" />
                    </label>
                    <label>
                        Height:
                        <InputNumber @bind-Value="advert.PuzzleDimensions.Height" step="0.1" />
                    </label>
                </div>
            </div>

            <button type="submit">Submit</button>
        </EditForm>
        
        @if (message != null)
        {
            <p>@message</p>
        }
    </div>
</section>




@code {
    Advert advert = new();

    string message;




    /// <summary>
    /// Handles the file input change event, reads the file, and stores it as a byte array in the advert.
    /// </summary>
    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        IBrowserFile file = e.File;
        if (file != null)
        {
            // Read the file into a memory stream (max 5 MB)
            using MemoryStream ms = new MemoryStream();
            await file.OpenReadStream(1024 * 1024 * 5).CopyToAsync(ms);
            advert.Picture = ms.ToArray();
        }
    }


    /// <summary>
    /// Called by the Blazor framework when the component is initialized.
    /// Redirects to home if the user is not logged in.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (state.CurrentUser == null)
        {
            nav.NavigateTo($"/");
        }
    }


    /// <summary>
    /// Clears the advert's picture.
    /// </summary>
    private void ClearFile()
    {
        advert.Picture = null;
    }


    /// <summary>
    /// Handles the form submission for creating a new advert.
    /// Sets the user and creation date, uploads the advert, and resets the form.
    /// </summary>
    private async Task NewAdvert()
    {
        advert.User = state.CurrentUser;
        advert.CreatedAt = DateTime.Now;

        await ad.AddAdvertAsync(advert);

        message = "Atvertisement has been uploaded!";
        // reset form data
        advert = new();
    }
}